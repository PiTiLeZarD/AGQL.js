version: "3.8"

x-agql: &agql
    image: agql.js:latest
    build:
        context: ..
        dockerfile: docker/Dockerfile
    volumes:
        - ..:/app
        - db:/db
        - node_modules:/app/node_modules
        - parcel_cache:/app/.parcel-cache

services:
    backend:
        <<: *agql
        container_name: agql_server_backend
        command: yarn server
        ports:
            - ${BACKEND_PORT}:${BACKEND_PORT}
        environment:
            - DEBUG=${DEBUG}
            - SERVER_PORT=${BACKEND_PORT}
            - SERVER_MODE=backend
            - SCHEMA_CONFIG_DB_PATH=${SCHEMA_CONFIG_DB_PATH}

    graphql:
        <<: *agql
        container_name: agql_server_graphql
        command: yarn server
        ports:
            - ${GRAPHQL_PORT}:${GRAPHQL_PORT}
        environment:
            - DEBUG=${DEBUG}
            - SERVER_PORT=${GRAPHQL_PORT}
            - SERVER_MODE=graphql
            - SCHEMA_CONFIG_DB_PATH=${SCHEMA_CONFIG_DB_PATH}

    admin:
        <<: *agql
        container_name: agql_admin
        command: yarn admin -p ${ADMIN_PORT}
        ports:
            - ${ADMIN_PORT}:${ADMIN_PORT}
        environment:
            - BACKEND_GQL_API_URL=${BACKEND_GQL_API_URL}
            - COMPILE_RELAY=1

volumes:
    db:
        name: agqldb
    node_modules:
        name: agqlnodemod
    parcel_cache:
        name: agqlparcelcache
